import csv
import xml.etree.ElementTree as ET
import argparse
import ssl

# Function to parse XML and convert it to CSV
def xml_to_csv(input_xml, output_csv):
    tree = ET.parse(input_xml)
    root = tree.getroot()

    with open(output_csv, 'w', newline='') as csvfile:
        csvwriter = csv.writer(csvfile)

        # Write the header row to the CSV, including the new fields
        csvwriter.writerow(['Host', 'Cipher', 'CipherStrength', 'KeyAlgorithm', 'KeyBits', 'SelfSigned','Serial', 'NotValidBefore', 'NotValidAfter', 'SubjectDN', 'IssuerDN'])

        # Iterate through the SSL tests in the XML
        for ssltest in root.findall('.//ssltest'):
            host = ssltest.get('host')

            for certificate in ssltest.findall('.//certificate'):
                signature_algorithm = certificate.find('signature-algorithm').text
                cipher = certificate.find('subject').text
                cipher_strength = certificate.find('pk').get('bits')
                key_algorithm = certificate.find('pk').get('type')
                key_bits = certificate.find('pk').get('bits')
                
                # Extract the self-signed attribute
                if certificate.get('type') == "short":
                    self_signed = certificate.find('self-signed').text
                else:
                    self_signed = "Not available"

                if certificate.get('type') == "full":
                    serial = certificate.find("serial").text
                else:
                    serial = "Not available"

                not_valid_before = certificate.find('not-valid-before').text
                not_valid_after = certificate.find('not-valid-after').text
                subject_dn = certificate.find('subject').text
                issuer_dn = certificate.find('issuer').text
                cert = ssl.get_server_certificate((host, 443))
                

                # Write the data to the CSV file, including the new fields
                csvwriter.writerow([host, cipher, cipher_strength, key_algorithm, key_bits, self_signed, serial, not_valid_before, not_valid_after, subject_dn, issuer_dn])

                # Print the PEM content for each certificate
                print(f"Certificate PEM for host '{host}':")
                print(cert)

    

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Convert XML data to CSV")
    parser.add_argument("--input", help="Input XML file", required=True)
    parser.add_argument("--output", help="Output CSV file", required=True)

    args = parser.parse_args()
    xml_to_csv(args.input, args.output)
